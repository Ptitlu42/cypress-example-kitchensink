name: Cypress Tests with Cucumber

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  cypress-tests:
    runs-on: ubuntu-latest
    container:
      image: cypress/base:latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Verify Cypress execution
        run: npx cypress verify

      - name: Start server and run standard e2e tests
        run: npm run test:ci:report
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Cucumber/Gherkin tests
        run: npx start-server-and-test start 8080 'npx cypress run --spec "cypress/e2e/**/*.feature" --reporter cypress-mochawesome-reporter'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Cucumber HTML report
        run: npm run generate:cucumber-report
        continue-on-error: true

      - name: Create comprehensive single-page report
        run: |
          mkdir -p cypress/reports
          
          # Backup any existing Mochawesome report
          if [ -f "cypress/reports/index.html" ]; then
            mv cypress/reports/index.html cypress/reports/mochawesome-original.html
          fi
          
          # Create comprehensive single page report with embedded content
          cat > cypress/reports/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Cypress Test Reports Dashboard</title>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; line-height: 1.6; }
                  .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 20px; text-align: center; }
                  .header h1 { font-size: 2.5em; margin-bottom: 10px; }
                  .header .subtitle { font-size: 1.2em; opacity: 0.9; }
                  .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
                  .section { background: white; margin: 30px 0; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
                  .section-header { background: #34495e; color: white; padding: 20px; font-size: 1.4em; display: flex; align-items: center; cursor: pointer; }
                  .section-header::before { margin-right: 15px; font-size: 1.5em; }
                  .cucumber-header::before { content: 'ðŸ¥’'; }
                  .artifacts-header::before { content: 'ðŸ“¹'; }
                  .summary-header::before { content: 'ðŸ“Š'; }
                  .section-content { padding: 30px; }
                  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 20px 0; }
                  .stat { text-align: center; padding: 20px; border-radius: 10px; color: white; font-weight: bold; }
                  .stat h3 { font-size: 2em; margin-bottom: 5px; }
                  .stat.total { background: #3498db; }
                  .stat.passed { background: #2ecc71; }
                  .stat.failed { background: #e74c3c; }
                  .stat.skipped { background: #f39c12; }
                  .feature { margin: 20px 0; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
                  .feature-header { background: #ecf0f1; padding: 15px; font-weight: bold; color: #2c3e50; }
                  .scenario { padding: 15px; border-bottom: 1px solid #eee; }
                  .scenario:last-child { border-bottom: none; }
                  .scenario.passed { background: #d5f4e6; border-left: 4px solid #2ecc71; }
                  .scenario.failed { background: #fdf2f2; border-left: 4px solid #e74c3c; }
                  .scenario h4 { margin-bottom: 10px; color: #2c3e50; }
                  .steps { margin: 10px 0; }
                  .step { padding: 8px 15px; margin: 3px 0; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.9em; }
                  .step.passed { background: #c8e6c9; border-left: 3px solid #2ecc71; }
                  .step.failed { background: #ffcdd2; border-left: 3px solid #e74c3c; }
                  .step.skipped { background: #fff3cd; border-left: 3px solid #f39c12; }
                  .step-keyword { font-weight: bold; color: #2c3e50; }
                  .artifact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
                  .artifact-item { padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center; border: 2px solid #e9ecef; transition: all 0.3s; }
                  .artifact-item:hover { border-color: #007bff; transform: translateY(-2px); }
                  .artifact-item h4 { margin-bottom: 10px; color: #2c3e50; }
                  .artifact-link { display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 6px; margin: 5px; transition: all 0.3s; cursor: pointer; border: none; }
                  .artifact-link:hover { background: #0056b3; transform: translateY(-1px); }
                  .timestamp { text-align: center; color: #6c757d; margin: 30px 0; font-style: italic; padding: 20px; background: white; border-radius: 10px; }
                  .no-data { text-align: center; color: #6c757d; padding: 40px; font-style: italic; background: #f8f9fa; border-radius: 8px; }
                  .collapsible { cursor: pointer; }
                  .collapsible:hover { background: #2c3e50; }
                  .content { display: block; }
                  .content.collapsed { display: none; }
                  
                  /* Dialog styles */
                  dialog { border: none; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 90vw; max-height: 90vh; padding: 0; }
                  dialog::backdrop { background: rgba(0,0,0,0.7); }
                  .dialog-header { background: #34495e; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
                  .dialog-title { font-size: 1.4em; font-weight: bold; }
                  .dialog-close { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2em; }
                  .dialog-close:hover { background: #c0392b; }
                  .dialog-content { padding: 20px; max-height: 70vh; overflow-y: auto; }
                  .file-list { list-style: none; }
                  .file-list li { padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff; }
                  .file-list a { color: #007bff; text-decoration: none; }
                  .file-list a:hover { text-decoration: underline; }
                  .json-content { background: #2d3748; color: #e2e8f0; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; white-space: pre-wrap; }
                  .iframe-container { width: 100%; height: 80vh; }
                  .iframe-container iframe { width: 100%; height: 100%; border: none; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ðŸ§ª Cypress Test Reports</h1>
                  <div class="subtitle">Comprehensive test results and artifacts</div>
              </div>
              
              <div class="container">
                  <div class="section">
                      <div class="section-header summary-header">Test Summary</div>
                      <div class="section-content">
                          <div class="stats">
                              <div class="stat total">
                                  <h3 id="total-tests">-</h3>
                                  <p>Total Tests</p>
                              </div>
                              <div class="stat passed">
                                  <h3 id="passed-tests">-</h3>
                                  <p>Passed</p>
                              </div>
                              <div class="stat failed">
                                  <h3 id="failed-tests">-</h3>
                                  <p>Failed</p>
                              </div>
                              <div class="stat skipped">
                                  <h3 id="skipped-tests">-</h3>
                                  <p>Skipped</p>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="section">
                      <div class="section-header cucumber-header collapsible">ðŸ¥’ Cucumber/Gherkin Test Results</div>
                      <div class="section-content content" id="cucumber-content">
          EOF
          
          # Add Cucumber results inline
          if [ -f "cypress/reports/cucumber-report.html" ]; then
            # Extract just the stats and features content
            awk '/<div class="stats">/,/<\/div>/ { 
              if (/<div class="stats">/) print; 
              else if (/<\/div>/ && !/stat/) print; 
              else if (/stat/) print 
            }' cypress/reports/cucumber-report.html >> cypress/reports/index.html
            
            awk '/<div class="feature">/,/<\/div>$/ { 
              if (!/container/) print 
            }' cypress/reports/cucumber-report.html >> cypress/reports/index.html
          else
            echo '                <div class="no-data">No Cucumber test results found. Tests may not have run successfully.</div>' >> cypress/reports/index.html
          fi
          
          cat >> cypress/reports/index.html << 'EOF'
                      </div>
                  </div>
                  
                  <div class="section">
                      <div class="section-header artifacts-header">ðŸ“¹ Test Artifacts & Reports</div>
                      <div class="section-content">
                          <div class="artifact-grid">
                              <div class="artifact-item">
                                  <h4>ðŸ“¸ Screenshots</h4>
                                  <p>Captured screenshots from failed tests</p>
                                  <button class="artifact-link" onclick="showScreenshots()">View Screenshots</button>
                              </div>
                              <div class="artifact-item">
                                  <h4>ðŸŽ¥ Videos</h4>
                                  <p>Full test execution recordings</p>
                                  <button class="artifact-link" onclick="showVideos()">Watch Videos</button>
                              </div>
                              <div class="artifact-item">
                                  <h4>ðŸ“„ JSON Reports</h4>
                                  <p>Raw Cucumber JSON test data</p>
                                  <button class="artifact-link" onclick="showJsonReports()">View JSON Data</button>
                              </div>
                              <div class="artifact-item">
                                  <h4>ðŸ“‹ Mochawesome Report</h4>
                                  <p>Standard Cypress test report</p>
                                  <button class="artifact-link" onclick="showMochawesome()">View Report</button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              
              <div class="timestamp">
                  ðŸ“… Report generated on: $(date)<br>
                  ðŸ”„ Last updated: $(date '+%Y-%m-%d %H:%M:%S')
              </div>
              
              <!-- Dialogs for each artifact type -->
              <dialog id="screenshots-dialog">
                  <div class="dialog-header">
                      <span class="dialog-title">ðŸ“¸ Test Screenshots</span>
                      <button class="dialog-close" onclick="closeDialog('screenshots-dialog')">&times;</button>
                  </div>
                  <div class="dialog-content">
                      <div id="screenshots-content">
                          <div class="no-data">Loading screenshots...</div>
                      </div>
                  </div>
              </dialog>
              
              <dialog id="videos-dialog">
                  <div class="dialog-header">
                      <span class="dialog-title">ðŸŽ¥ Test Videos</span>
                      <button class="dialog-close" onclick="closeDialog('videos-dialog')">&times;</button>
                  </div>
                  <div class="dialog-content">
                      <div id="videos-content">
                          <div class="no-data">Loading videos...</div>
                      </div>
                  </div>
              </dialog>
              
              <dialog id="json-dialog">
                  <div class="dialog-header">
                      <span class="dialog-title">ðŸ“„ JSON Reports</span>
                      <button class="dialog-close" onclick="closeDialog('json-dialog')">&times;</button>
                  </div>
                  <div class="dialog-content">
                      <div id="json-content">
                          <div class="no-data">Loading JSON reports...</div>
                      </div>
                  </div>
              </dialog>
              
              <dialog id="mochawesome-dialog">
                  <div class="dialog-header">
                      <span class="dialog-title">ðŸ“‹ Mochawesome Report</span>
                      <button class="dialog-close" onclick="closeDialog('mochawesome-dialog')">&times;</button>
                  </div>
                  <div class="dialog-content">
                      <div class="iframe-container" id="mochawesome-content">
          EOF
          
          # Embed Mochawesome report if it exists
          if [ -f "cypress/reports/mochawesome-original.html" ]; then
            echo '                <iframe src="data:text/html;base64,' >> cypress/reports/index.html
            base64 -w 0 cypress/reports/mochawesome-original.html >> cypress/reports/index.html
            echo '"></iframe>' >> cypress/reports/index.html
          else
            echo '                <div class="no-data">No Mochawesome report found</div>' >> cypress/reports/index.html
          fi
          
          cat >> cypress/reports/index.html << 'EOF'
                      </div>
                  </div>
              </dialog>
              
              <script>
                  function toggleSection(element) {
                      const content = element.nextElementSibling;
                      content.classList.toggle('collapsed');
                  }
                  
                  function showDialog(dialogId) {
                      document.getElementById(dialogId).showModal();
                  }
                  
                  function closeDialog(dialogId) {
                      document.getElementById(dialogId).close();
                  }
                  
                  function showScreenshots() {
                      // In a real implementation, you would fetch and display screenshots
                      document.getElementById('screenshots-content').innerHTML = `
                          <div class="no-data">
                              Screenshots would be displayed here.<br>
                              In GitHub Pages environment, files are typically in the screenshots/ directory.
                          </div>
                      `;
                      showDialog('screenshots-dialog');
                  }
                  
                  function showVideos() {
                      document.getElementById('videos-content').innerHTML = `
                          <div class="no-data">
                              Videos would be displayed here.<br>
                              In GitHub Pages environment, files are typically in the videos/ directory.
                          </div>
                      `;
                      showDialog('videos-dialog');
                  }
                  
                  function showJsonReports() {
          EOF
          
          # Add JSON content inline
          echo '            const jsonData = `' >> cypress/reports/index.html
          if [ -d "cypress/cucumber-json" ] && [ "$(ls -A cypress/cucumber-json 2>/dev/null)" ]; then
            for file in cypress/cucumber-json/*.json; do
              if [ -f "$file" ]; then
                echo "=== $(basename "$file") ===" >> cypress/reports/index.html
                cat "$file" >> cypress/reports/index.html
                echo "" >> cypress/reports/index.html
              fi
            done
          else
            echo "No JSON files found" >> cypress/reports/index.html
          fi
          echo '`;' >> cypress/reports/index.html
          
          cat >> cypress/reports/index.html << 'EOF'
                      document.getElementById('json-content').innerHTML = `
                          <div class="json-content">${jsonData}</div>
                      `;
                      showDialog('json-dialog');
                  }
                  
                  function showMochawesome() {
                      showDialog('mochawesome-dialog');
                  }
                  
                  // Add click handlers to collapsible headers
                  window.onload = function() {
                      document.querySelectorAll('.section-header.collapsible').forEach(header => {
                          header.onclick = () => toggleSection(header);
                      });
                      
                      // Calculate test summary from Cucumber data
                      updateTestSummary();
                  }
                  
                  function updateTestSummary() {
                      const scenarios = document.querySelectorAll('.scenario');
                      const passed = document.querySelectorAll('.scenario.passed').length;
                      const failed = document.querySelectorAll('.scenario.failed').length;
                      const total = scenarios.length;
                      const skipped = 0; // Cucumber doesn't typically have skipped scenarios
                      
                      document.getElementById('total-tests').textContent = total || '-';
                      document.getElementById('passed-tests').textContent = passed || '-';
                      document.getElementById('failed-tests').textContent = failed || '-';
                      document.getElementById('skipped-tests').textContent = skipped || '-';
                  }
              </script>
          </body>
          </html>
          EOF

      - name: Remove intermediate step
        run: echo "Single page report created successfully"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          retention-days: 30

      - name: Upload test videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos
          retention-days: 30

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-reports
          path: cypress/reports
          retention-days: 30

      - name: Upload Cucumber reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cucumber-reports
          path: cypress/cucumber-json
          retention-days: 30

      - name: Prepare Pages content
        run: |
          mkdir -p pages-content
          cp -r cypress/reports/* pages-content/ 2>/dev/null || true
          cp -r cypress/screenshots pages-content/ 2>/dev/null || true
          cp -r cypress/videos pages-content/ 2>/dev/null || true
          cp -r cypress/cucumber-json pages-content/ 2>/dev/null || true
          ls -la pages-content/

      - name: Setup Pages
        uses: actions/configure-pages@v4
        if: always()

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        if: always()
        with:
          path: pages-content

  deploy:
    if: always()
    needs: cypress-tests
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 