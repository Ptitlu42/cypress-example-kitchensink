name: Cypress Tests with Cucumber

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  cypress-tests:
    runs-on: ubuntu-latest
    container:
      image: cypress/base:latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Verify Cypress execution
        run: npx cypress verify

      - name: Start server and run standard e2e tests
        run: npm run test:ci:report
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Cucumber/Gherkin tests
        run: npx start-server-and-test start 8080 'npx cypress run --spec "cypress/e2e/**/*.feature" --reporter cypress-mochawesome-reporter'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Cucumber HTML report
        run: npm run generate:cucumber-report
        continue-on-error: true

      - name: Create comprehensive single-page report
        run: |
          mkdir -p cypress/reports
          
          # Backup any existing Mochawesome report
          if [ -f "cypress/reports/index.html" ]; then
            mv cypress/reports/index.html cypress/reports/mochawesome-original.html
          fi
          
          # Create comprehensive single page report
          cat > cypress/reports/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Cypress Test Reports Dashboard</title>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; line-height: 1.6; }
                  .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 20px; text-align: center; }
                  .header h1 { font-size: 2.5em; margin-bottom: 10px; }
                  .header .subtitle { font-size: 1.2em; opacity: 0.9; }
                  .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
                  .section { background: white; margin: 30px 0; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
                  .section-header { background: #34495e; color: white; padding: 20px; font-size: 1.4em; display: flex; align-items: center; cursor: pointer; }
                  .section-header::before { margin-right: 15px; font-size: 1.5em; }
                  .cucumber-header::before { content: 'ðŸ¥’'; }
                  .artifacts-header::before { content: 'ðŸ“¹'; }
                  .summary-header::before { content: 'ðŸ“Š'; }
                  .section-content { padding: 30px; }
                  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 20px 0; }
                  .stat { text-align: center; padding: 20px; border-radius: 10px; color: white; font-weight: bold; }
                  .stat h3 { font-size: 2em; margin-bottom: 5px; }
                  .stat.total { background: #3498db; }
                  .stat.passed { background: #2ecc71; }
                  .stat.failed { background: #e74c3c; }
                  .stat.skipped { background: #f39c12; }
                  .feature { margin: 20px 0; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
                  .feature-header { background: #ecf0f1; padding: 15px; font-weight: bold; color: #2c3e50; }
                  .scenario { padding: 15px; border-bottom: 1px solid #eee; }
                  .scenario:last-child { border-bottom: none; }
                  .scenario.passed { background: #d5f4e6; border-left: 4px solid #2ecc71; }
                  .scenario.failed { background: #fdf2f2; border-left: 4px solid #e74c3c; }
                  .scenario h4 { margin-bottom: 10px; color: #2c3e50; }
                  .steps { margin: 10px 0; }
                  .step { padding: 8px 15px; margin: 3px 0; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.9em; }
                  .step.passed { background: #c8e6c9; border-left: 3px solid #2ecc71; }
                  .step.failed { background: #ffcdd2; border-left: 3px solid #e74c3c; }
                  .step.skipped { background: #fff3cd; border-left: 3px solid #f39c12; }
                  .step-keyword { font-weight: bold; color: #2c3e50; }
                  .artifact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
                  .artifact-item { padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center; border: 2px solid #e9ecef; transition: all 0.3s; }
                  .artifact-item:hover { border-color: #007bff; transform: translateY(-2px); }
                  .artifact-item h4 { margin-bottom: 10px; color: #2c3e50; }
                  .artifact-link { display: inline-block; padding: 12px 24px; background: #007bff; color: white; text-decoration: none; border-radius: 6px; margin: 5px; transition: all 0.3s; }
                  .artifact-link:hover { background: #0056b3; transform: translateY(-1px); }
                  .timestamp { text-align: center; color: #6c757d; margin: 30px 0; font-style: italic; padding: 20px; background: white; border-radius: 10px; }
                  .no-data { text-align: center; color: #6c757d; padding: 40px; font-style: italic; background: #f8f9fa; border-radius: 8px; }
                  .collapsible { cursor: pointer; }
                  .collapsible:hover { background: #2c3e50; }
                  .content { display: block; }
                  .content.collapsed { display: none; }
              </style>
              <script>
                  function toggleSection(element) {
                      const content = element.nextElementSibling;
                      content.classList.toggle('collapsed');
                  }
                  
                  window.onload = function() {
                      // Add click handlers to collapsible headers
                      document.querySelectorAll('.section-header.collapsible').forEach(header => {
                          header.onclick = () => toggleSection(header);
                      });
                  }
              </script>
          </head>
          <body>
              <div class="header">
                  <h1>ðŸ§ª Cypress Test Reports</h1>
                  <div class="subtitle">Comprehensive test results and artifacts</div>
              </div>
              
              <div class="container">
                  <div class="section">
                      <div class="section-header summary-header">Test Summary</div>
                      <div class="section-content">
                          <div class="stats">
                              <div class="stat total">
                                  <h3 id="total-tests">-</h3>
                                  <p>Total Tests</p>
                              </div>
                              <div class="stat passed">
                                  <h3 id="passed-tests">-</h3>
                                  <p>Passed</p>
                              </div>
                              <div class="stat failed">
                                  <h3 id="failed-tests">-</h3>
                                  <p>Failed</p>
                              </div>
                              <div class="stat skipped">
                                  <h3 id="skipped-tests">-</h3>
                                  <p>Skipped</p>
                              </div>
                          </div>
                      </div>
                  </div>
          EOF
          
          # Add Cucumber results section
          echo '        <div class="section">' >> cypress/reports/index.html
          echo '          <div class="section-header cucumber-header collapsible">ðŸ¥’ Cucumber/Gherkin Test Results</div>' >> cypress/reports/index.html
          echo '          <div class="section-content content">' >> cypress/reports/index.html
          
          if [ -f "cypress/reports/cucumber-report.html" ]; then
            # Extract just the content we need from the cucumber report
            awk '/<div class="stats">/,/<\/div>/ { if (/<div class="stats">/) print; else if (/<\/div>/ && !/stat/) print; else if (/stat/) print }' cypress/reports/cucumber-report.html >> cypress/reports/index.html
            awk '/<div class="feature">/,/<\/div>$/ { if (!/container/) print }' cypress/reports/cucumber-report.html >> cypress/reports/index.html
          else
            echo '            <div class="no-data">No Cucumber test results found. Tests may not have run successfully.</div>' >> cypress/reports/index.html
          fi
          
          echo '          </div>' >> cypress/reports/index.html
          echo '        </div>' >> cypress/reports/index.html
          
          # Add artifacts section
          cat >> cypress/reports/index.html << 'EOF'
                  <div class="section">
                      <div class="section-header artifacts-header collapsible">ðŸ“¹ Test Artifacts & Downloads</div>
                      <div class="section-content content">
                          <div class="artifact-grid">
                              <div class="artifact-item">
                                  <h4>ðŸ“¸ Screenshots</h4>
                                  <p>Captured screenshots from failed tests</p>
                                  <a href="screenshots/" class="artifact-link">Browse Screenshots</a>
                              </div>
                              <div class="artifact-item">
                                  <h4>ðŸŽ¥ Videos</h4>
                                  <p>Full test execution recordings</p>
                                  <a href="videos/" class="artifact-link">Watch Videos</a>
                              </div>
                              <div class="artifact-item">
                                  <h4>ðŸ“„ JSON Reports</h4>
                                  <p>Raw Cucumber JSON test data</p>
                                  <a href="cucumber-json/" class="artifact-link">View JSON Data</a>
                              </div>
                              <div class="artifact-item">
                                  <h4>ðŸ“‹ Original Mochawesome</h4>
                                  <p>Standard Cypress test report</p>
                                  <a href="mochawesome-original.html" class="artifact-link">View Report</a>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              
              <div class="timestamp">
                  ðŸ“… Report generated on: $(date)<br>
                  ðŸ”„ Last updated: $(date '+%Y-%m-%d %H:%M:%S')
              </div>
          </body>
          </html>
          EOF

      - name: Remove intermediate step
        run: echo "Single page report created successfully"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          retention-days: 30

      - name: Upload test videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos
          retention-days: 30

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-reports
          path: cypress/reports
          retention-days: 30

      - name: Upload Cucumber reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cucumber-reports
          path: cypress/cucumber-json
          retention-days: 30

      - name: Prepare Pages content
        run: |
          mkdir -p pages-content
          cp -r cypress/reports/* pages-content/ 2>/dev/null || true
          cp -r cypress/screenshots pages-content/ 2>/dev/null || true
          cp -r cypress/videos pages-content/ 2>/dev/null || true
          cp -r cypress/cucumber-json pages-content/ 2>/dev/null || true
          ls -la pages-content/

      - name: Setup Pages
        uses: actions/configure-pages@v4
        if: always()

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        if: always()
        with:
          path: pages-content

  deploy:
    if: always()
    needs: cypress-tests
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 